#!/bin/sh
#############################################################################
# This is a Chisel RTL generator configuration script file. 
# The purpose is to control the compilation and testing
# in parametrized manner from this single file
# Created by Marko Kosunen on 24.03.2015
# Last modification by Marko Kosunen, marko.kosunen@aalto.fi, 11.12.2018 20:27
#############################################################################
##Function to display help with -h argument and to control 
##The configuration from the commnad line
help_f()
{
    echo -e "CONFIGURE Release 1.0 (04.04.2016)"
    echo -e "configure-configuration script for Chisel RTL generation"
    echo -e "Written by Marko "Pikkis" Kosunen"
    echo -e -n "\n"
    echo -e "SYNOPSIS"
    echo -e "  configure [OPTIONS] "
    echo -e "DESCRIPTION"
    echo -e "  Producess all configurations and Makefile for the Chisel RTL generation"
    echo -e -n "\n"
    echo -e "OPTIONS"
    echo -e "  -h"
    echo -e "      Show this help."
}

while getopts h opt
do
  case "$opt" in
    h) help_f; exit 0;;
    \?) help_f;;
  esac
done


#$FIRRTL #Sets up THESDKHOME from gloabl setup file
#. ../../TheSDK.config
ROOTPATH=`pwd`
VERILOGDIR=verilog
VERILOGPATH=${ROOTPATH}/${VERILOGDIR}
SCALAPATH=${ROOTPATH}/src/main/scala
FIRRTL_JAR="$ROOTPATH/rocket-chip/firrtl/utils/bin/firrtl.jar"

VPATHDIRS=`find ${SCALAPATH}/* -type d -exec basename '{}' ';'`
MAINMODULE="fir"
MODULES="fir"
TEST_MODULES=""
PACKAGE="fir"


############################# MAKEFILE   ####################################
CURRENTFILE="${ROOTPATH}/Makefile"

echo "Creating ${CURRENTFILE} for modules:"
for i in ${MODULES}; do
    echo $i
done

cat <<EOF > ${CURRENTFILE}
#Directories
#Directories
VERILOGDIR ?= ${VERILOGDIR}
VERILOGPATH = ${VERILOGPATH}
SCALAPATH = ${SCALAPATH}
#DEPDIR :=.depdir
#\$(shell mkdir -p \$(DEPDIR) >/dev/null)
\$(shell mkdir -p \$(VERILOGPATH) >/dev/null)
MODULES= ${MODULES}
TEST_MODULES=${TEST_MODULES}
PACKAGE=${PACKAGE}

TARGETS = \$(foreach name,\$(MODULES), \$(VERILOGDIR)/\$(name).v)
TEST_TARGETS = \$(foreach name,\$(TEST_MODULES), test_\$(name))

#Commands
SBT=sbt -J-Xmx16G -J-Xss8M

# Default parameters
taps ?= 16
coeffs ?= "1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 12, 13, 14, 15, 16"
gainbits ?= 10

MAINPARAMS = -n \$(taps) -c \$(coeffs) -g \$(gainbits)



TOUCH=touch -r
`for i in ${VPATHDIRS}; do
    echo vpath %.scala \\$\(SCALAPATH\)/$i
done`
.PHONY: all help clean \$(MODULES)


all: \$(TARGETS)

# Test all in TEST_TARGETS
test: \
`
echo ""
echo -en "\t\\$(SBT) 'testOnly"
for i in ${TEST_MODULES}; do
    echo -n " ${PACKAGE}.$i"
done
echo "'"
`


${MAINMODULE}: 
	\$(VERILOGDIR)/${MAINMODULE}.v
\$(VERILOGDIR)/${MAINMODULE}.v:
	\$(eval class:=\$(basename \$(notdir \$@)))
	\$(SBT) 'runMain ${PACKAGE}.${MAINMODULE} \$(MAINPARAMS) -t \$(VERILOGDIR)'

#Generate recipes for individual modules
`for i in ${MODULES}; do
    echo -e "$i: \\$(VERILOGPATH)/$i.v"
done`

clean:
	rm -f \$(VERILOGPATH)/*.v
	rm -f \$(VERILOGPATH)/*.anno
	rm -f \$(VERILOGPATH)/*.fir
	rm -rf \$(VERILOGPATH)
	#rm -rf \$(DEPDIR)

#Generate cleanup recipes for individual modules
`for i in ${MODULES}; do
	echo .PHONY: clean_$i
	echo clean_$i: 
	echo -e "\trm -f \\$(VERILOGPATH)/$i.v"
	echo -e "\trm -f \\$(VERILOGPATH)/$i.anno"
	echo -e "\trm -f \\$(VERILOGPATH)/$i.fir"
    echo -e "\trm -f \\$(VERILOGPATH)/${i}_memmapped.conf"
    echo -e "\trm -f \\$(VERILOGPATH)/${i}_memmapped.v"
done`

help:
	@echo "configured modules are:";
	@for i in \$(MODULES) ; do \\
	   echo \$\$i; \\
	done
EOF
##################Hereafter some files you should not need to modify ################################

